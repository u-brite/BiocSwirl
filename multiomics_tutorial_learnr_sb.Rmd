---
title: "Multimodal Workflow Tutorial"
output: learnr::tutorial
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
library(learnr)
knitr::opts_chunk$set(echo = FALSE)
```

## Introduction

### **Multimodal Workflow Tutorial Combining scATAC-seq with scRNA-seq**
#### **Team BiocSwirl:** Sayan Bakshi, Yong Wang, Kingsley Bentum, Lisa N. Cao, Almas Khan (Team Leader)

### What is ATAC-seq?

-   ATAC-seq stands for Assay for Transposase-Accessible Chromatin with high-throughput sequencing. 
-   The technique uses the Tn5 transposase enzyme to fragment chromatin while simultaneously integrating Next Generation Sequencing (NGS) adapters into the open (active) loci of chromatin. 
-   The library generated from the fragmentation is then sequenced by NGS and the open chromatin regions allowing for successful NGS adapters integration analyzed using bioinformatics tools. 
-   ATAC-seq is a simple two-step protocol compared to other techniques and requires a relatively low number of cells for the assay. 
-   With ATAC-seq, researchers are provided with information on chromatin accessibility across the entire genome and can be used as a screening tool even before further experimental works.

![](https://www.youtube.com/watch?v=L2Kxaq9yRE4)

```{r text_box, echo = FALSE}
question_text(
  "What is the full meaning of the acronym ATAC in 'ATAC-seq'? (Capitalize A-T-A-C):",
  answer("Assay for Transposase-Accessible Chromatin", correct = TRUE),
  allow_retry = TRUE
)
```

```{r quiz-0_1}
quiz(
  question("Which regions on a chromatin are considered active?",
    answer("open regions", correct = TRUE),
    answer("closed regions"),
    answer("wide regions"),
    answer("no regions"))
  )
```

```{r quiz-0_2}
quiz(
  question("The genes controlled by promoters and enhancers in an opened region will be expressed. (TRUE/FALSE)",
    answer("True", correct = TRUE),
    answer("False"))
  )
```

```{r quiz-0_3}
quiz(
  question("What is the name of the enzyme used in ATAC-seq?",
    answer("Taq polymerase"),
    answer("RNA polymerase"),
    answer("Tn5 transposase", correct = TRUE),
    answer("Reverse transcriptase"))
  )
```

```{r quiz-0_4}
quiz(
  question("Some information we can deduce from an ATAC-seq experiment include:",
    answer("Total number of genes on a chromosome"),
    answer("The opening of a chromatin loci", correct = TRUE),
    answer("The closure of chromatin loci", correct = TRUE),
    answer("All of the above"))
  )
```

Single-cell ATAC-seq (scATAC-seq) technology has also been developed to study cell type-specific chro-
matin accessibility in tissue samples containing a heterogeneous cellular population _(Baek S, Lee I. CSBJ. 2020)_. 

## **Topic 1 : Setting Up**

### Libraries

In this section, we will load the necessary packages and download the raw data.

Write the R code required to load the following necessary libraries:
_Signac, Seurat, GenomeInfoDb, EnsDb.Hsapiens.v75, ggplot2, patchwork, hdf5r_

```{r libraries-seeds, include=FALSE}
library(Signac)
library(Seurat)
library(GenomeInfoDb)
library(EnsDb.Hsapiens.v75)
library(ggplot2)
library(patchwork)
  library('hdf5r') ## was not included in the tutorial
set.seed(1234)
```

```{r load-libraries, exercise=TRUE}

```

### Setting seed

Next, we will set a random number as a seed to ensure that we get the same result everytime.

Write the R code to set a random seed:

```{r set-seed, exercise=T}

```

```{r quiz-1}
quiz(
  question("What is the purpose of setting seed?",
    answer("loading libraries"),
    answer("downloading a dataset"),
    answer("reproducibility", correct = TRUE))
  )
```

### Downloading Dataset

_Please make a folder called data within the tutorial package, download these files <links>, and keep the downloaded files within the 'data' folder_

## **Topic 2 : Pre-processing Workflow**

Signac uses peak/cell matrix and the fragment file information. To that end, we need to create a Seurat object using peak/cell matrix and cell metadata, and store the path to the fragment file on disk in the Seurat object.

```{r lib2, include=F}
library(sortable)
```

```{r sort-workflow, echo=FALSE}

steps <- c(
    "load filtered peak/cell matrix",
    "create chromatin assay with the genome information",
    "create a Seurat object to compute QC matrices"
    )

question_rank(
  "Sort these steps in the order of workflow:",
  answer(steps, correct = TRUE),
  allow_retry = TRUE
 )
```

### Load the peak matrix

```{r load-peak-matrix, exercise=TRUE, exercise.eval=TRUE}

```

```{r load-peak-matrix-hint}
counts <- Read10X_h5(filename = "../../Project/Raw_data/atac_v1_pbmc_10k_filtered_peak_bc_matrix.h5")
```

### Load the metadata:

```{r load-metadata, exercise=TRUE, exercise.eval=TRUE}

```

```{r load-metadata-hint}
metadata <- read.csv(
  file = "../../Project/Raw_data/atac_v1_pbmc_10k_singlecell.csv",
  header = TRUE,
  row.names = 1
)
```

### Create Chromatin Assay:

```{r chrom-assay, exercise=TRUE, exercise.eval=TRUE}

```

```{r chrom-assay-hint}
chrom_assay <- CreateChromatinAssay(
  counts = counts,
  sep = c(":", "-"),
  genome = 'hg19',
  fragments = '../Project/Raw_data/atac_v1_pbmc_10k_fragments.tsv.gz',
  min.cells = 10,
  min.features = 200
)
```

```{r quiz-2}
quiz(
  question("Counts used in the creation of the ChromatinAssay are:",
    answer("Unnormalized or Raw", correct = TRUE),
    answer("Normalized"))
  )
```

Create a ChromatinAssay object to include features detected in at least 20 cells:

```{r chrom-assay-2, exercise=TRUE, exercise.eval=TRUE}

```

```{r chrom-assay-2-hint}
# change the value of min.cells to 20
```

### Create Seurat Object:

```{r seu-obj, exercise=TRUE, exercise.eval=TRUE}

```

```{r seu-obj-hint}
pbmc <- CreateSeuratObject(
  counts = chrom_assay,
  assay = "peaks",
  meta.data = metadata
)
```

Run a code to explore the stored peak feature and cell information within the SeuratObject:

```{r peaks-info}

```

```{r peaks-original, include=FALSE}

```

### Extract Gene Annotation and add it to the SeuratObject:

```{r gene-annot, exercise=TRUE, exercise.eval=TRUE}

```

```{r gene-annot-hint}
# extract gene annotations from EnsDb
annotations <- GetGRangesFromEnsDb(ensdb = EnsDb.Hsapiens.v75)

# change to UCSC style since the data was mapped to hg19
seqlevelsStyle(annotations) <- 'UCSC'

# add the gene information to the object
Annotation(pbmc) <- annotations

```

Run a code to include annotations from only protein-coding biotypes:

```{r annot-info, exercise=TRUE, exercise.eval=TRUE}

```

```{r annot-info-hint}
GetGRangesFromEnsDb(
  ensdb,
  standard.chromosomes = TRUE,
  biotypes = c("protein_coding"), # make sure that biotypes option only include 'protein-coding'
  verbose = TRUE
)
```

## **Topic 3 : Computing QC Metrices**

### Computing QC Metrics

Run a code to compute nucleosome signal score per cell:

```{r nucl-sig, exercise=TRUE, exercise.eval=TRUE}

```

```{r nucl-sig-hint}
pbmc <- NucleosomeSignal(object = pbmc)
```

```{r quiz-3, echo=FALSE}
quiz(
  question("Why we calculate NucleosomeSignal? (Select all that apply)",
  answer("Quantify the approximate ratio of mononucleosomal to nucleosome-free fragments", correct = TRUE),
  answer("The histogram of DNA fragment sizes should exhibit a strong nucleosome banding pattern", correct = TRUE))
)
```

Next, we will compute TSS (Transcription Start Site) enrichment score per cell with `TSSEnrichment`. It takes 15-20 minutes to run. You can allow it to run or alternatively, load a pre-run object at this step.

```{r tss-enrich, include=FALSE, eval=FALSE}
pbmc <- TSSEnrichment(object = pbmc, fast = FALSE)
```

Calculate the blacklist ratio and fraction of reads in peaks and add it to the SeuratObject:

```{r blacklist, exercise=TRUE, exercise.eval=TRUE}

```

```{r blacklist-hint}
pbmc$pct_reads_in_peaks <- pbmc$peak_region_fragments / pbmc$passed_filters * 100
pbmc$blacklist_ratio <- pbmc$blacklist_region_fragments / pbmc$peak_region_fragments
```

```{r quiz-4, echo=FALSE}
quiz(
  question("What are the QC metrics for the scATAC-seq experiment? (Select all that apply)",
  answer("Nucleosome banding pattern", correct = TRUE),
  answer("Transcriptional start site (TSS) enrichment score", correct = TRUE),
  answer("Total number of fragments in peaks", correct = TRUE),
  answer("Fraction of fragments in peaks:", correct = TRUE),
  answer("Ratio reads in genomic blacklist regions ", correct = TRUE))
)
```

In the next step, inspect the TSS enrichment scores by grouping the cells based on the score:

```{r tss-filter, exercise=TRUE, exercise.eval=TRUE}

```

```{r tss-filter-hint}
pbmc$high.tss <- ifelse(pbmc$TSS.enrichment > 2, 'High', 'Low')
```

Plot the accessibility signal over all TSS sites with `TSSPlot` by grouping cells with high or low nucleosomal signal strength:

```{r tss-filter-plot, exercise=TRUE, exercise.eval=TRUE}

```

```{r tss-filter-plot-hint}
TSSPlot(pbmc, group.by = 'high.tss') + NoLegend()
```

Inspect the fragment length periodicity for all the cells and group by cells with high or low nucleosomal signal strength:

```{r frag-hist, exercise=TRUE, exercise.eval=TRUE}

```

```{r frag-hist-hint}
pbmc$nucleosome_group <- ifelse(pbmc$nucleosome_signal > 4, 'NS > 4', 'NS < 4')
FragmentHistogram(object = pbmc, group.by = 'nucleosome_group')
```

Make violin plots for QC metrics:
_QC metrics to include: 'pct_reads_in_peaks', 'peak_region_fragments', 'TSS.enrichment', 'blacklist_ratio', 'nucleosome_signal'_

```{r vlnplot, exercise=TRUE, exercise.eval=TRUE}

```

```{r vlnplot-hint}
VlnPlot(
  object = pbmc,
  features = c('pct_reads_in_peaks', 'peak_region_fragments',
               'TSS.enrichment', 'blacklist_ratio', 'nucleosome_signal'),
  pt.size = 0.1,
  ncol = 5
)
```

Remove cells that are outliers for QC metrices:

```{r filter-cell, exercise=TRUE, exercise.eval=TRUE}

```

```{r filter-cell-hint}
pbmc <- subset(
  x = pbmc,
  subset = peak_region_fragments > 3000 &
    peak_region_fragments < 20000 &
    pct_reads_in_peaks > 15 &
    blacklist_ratio < 0.05 &
    nucleosome_signal < 4 &
    TSS.enrichment > 2
)
```

## **Topic 4 : Normalization and linear dimensional reduction**

We will use the combined steps of TF-IDF followed by SVD (known as LSI), which were first introduced for the analysis of scATAC-seq data by _Cusanovich et al. 2015_.

```{r norm, exercise=TRUE, exercise.eval=TRUE}

```

```{r norm-hint}
pbmc <- RunTFIDF(pbmc)
pbmc <- FindTopFeatures(pbmc, min.cutoff = 'q0')
pbmc <- RunSVD(pbmc)
```

```{r quiz-5, echo=FALSE}
quiz(
  question("What is the two-step normalization precedure of Signac? (Select all that apply)",
  answer("Normalize across cells to correct for differences in cellular sequencing depth", correct =TRUE),
  answer("Normalize across peaks to give higher values to more rare peaks", correct = TRUE))
)  
```

```{r quiz-6, echo=FALSE}
quiz(question("What type of normalization does Signac perform? (Select all that apply)",
  answer("Term frequency-inverse document frequency (TF-IDF)", correct =TRUE),
  answer("Normalize across peaks to give higher values to more rare peaks", correct = TRUE)
))
```

```{r quiz-7, echo=FALSE}
quiz(question("What type of dimension reduction does Signac perform? (select All that apply)",
  answer("singular value decomposition (SVD), similar to the output of PCA used for scRNA-seq", correct =TRUE),
  answer("normalize across peaks to give higher values to more rare peaks", correct = TRUE)
))
```

```{r text_box_2, echo = FALSE}
question_text(
  "What are the combined steps of TF-IDF followed by SVD known as? (Capitalize):",
  answer("Latent Semantic Indexing", correct = TRUE),
  allow_retry = TRUE
)
```

## **Topic 5 : Non-linear dimension reduction and clustering**

Utilize common scRNAseq-data-analysis functions:

```{r quiz-x, echo=FALSE}
quiz(
  question("What are the fuctions used for non-linear dimension reduction and clustering?)",
  answer("RunUMAP()", correct =TRUE),
  answer("FindNeighbors()", correct = TRUE),
  answer("FindCluters()", correct = TRUE),
  answer("SVD"),
  answer("PCA"))
)
```

```{r nldrc, exercise=TRUE, exercise.eval=TRUE}

```

```{r nldrc-hint}
pbmc <- RunUMAP(object = pbmc, reduction = 'lsi', dims = 2:30)
pbmc <- FindNeighbors(object = pbmc, reduction = 'lsi', dims = 2:30)
pbmc <- FindClusters(object = pbmc, verbose = FALSE, algorithm = 3)
```

Perform visualization of non-linear dimension reduction and graph-based clustering:

```{r nldrc-plot, exercise=TRUE, exercise.eval=TRUE}

```

```{r nldrc-plot-hint}
DimPlot(object = pbmc, label = TRUE) + NoLegend()
```

## **Topic 6 : Create a Gene Activity Matrix**


## **Topic 7 : Integrating scATAC-seq data with scRNA-seq data**

While scATAC-seq informs us of chromatin accessibility changes, incorporating scRNA-seq data from the same system (human PBMC) provides quantitative gene expression data associated with differential chromatin accessibility changes surrounding respective TSS. Hence, we can identify the shared changes across two modalities for relevant biological inference.
